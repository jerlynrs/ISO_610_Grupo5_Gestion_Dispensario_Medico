{% extends 'base_dashboard.html' %}
{% block content %}
<div class="container mt-4">
  <h4>Consulta de Visitas por Criterios</h4>
  
  <!-- Formulario de búsqueda -->
  <div class="card mb-4">
    <div class="card-header">
      <h5>Filtros de Búsqueda</h5>
    </div>
    <div class="card-body">
      <form method="GET" action="{{ url_for('consultas') }}">
        <div class="row">
          <div class="col-md-3">
            <div class="form-group">
              <label for="paciente_nombre">Nombre del Paciente</label>
              <input type="text" class="form-control" name="paciente_nombre" value="{{ paciente_nombre }}" placeholder="Buscar por nombre...">
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="medico_nombre">Nombre del Médico</label>
              <input type="text" class="form-control" name="medico_nombre" value="{{ medico_nombre }}" placeholder="Buscar por médico...">
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="fecha_desde">Fecha Desde</label>
              <input type="date" class="form-control" name="fecha_desde" value="{{ fecha_desde }}">
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="fecha_hasta">Fecha Hasta</label>
              <input type="date" class="form-control" name="fecha_hasta" value="{{ fecha_hasta }}">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-12">
            <button type="submit" class="btn btn-primary">Buscar</button>
            <a href="{{ url_for('consultas') }}" class="btn btn-secondary">Limpiar</a>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Resultados -->
  <div class="card">
    <div class="card-header">
      <h5>Resultados de la Búsqueda ({{ resultados|length }} registros encontrados)</h5>
    </div>
    <div class="card-body">
      {% if resultados %}
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="thead-dark">
              <tr>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Paciente</th>
                <th>Médico</th>
                <th>Especialidad</th>
                <th>Medicamento</th>
                <th>Síntomas</th>
                <th>Recomendaciones</th>
              </tr>
            </thead>
            <tbody>
              {% for visita, paciente, medico, medicamento in resultados %}
                <tr>
                  <td>{{ visita.fecha.strftime('%d/%m/%Y') if visita.fecha else 'N/A' }}</td>
                  <td>{{ visita.hora.strftime('%H:%M') if visita.hora else 'N/A' }}</td>
                  <td>
                    <strong>{{ paciente.nombre }}</strong><br>
                    <small class="text-muted">{{ paciente.cedula }}</small>
                  </td>
                  <td>{{ medico.nombre }}</td>
                  <td>{{ medico.especialidad }}</td>
                  <td>{{ medicamento.descripcion if medicamento else 'Sin medicamento' }}</td>
                  <td>
                    <span data-toggle="tooltip" title="{{ visita.sintomas }}">
                      {{ visita.sintomas[:50] }}{% if visita.sintomas|length > 50 %}...{% endif %}
                    </span>
                  </td>
                  <td>
                    <span data-toggle="tooltip" title="{{ visita.recomendaciones }}">
                      {{ visita.recomendaciones[:50] }}{% if visita.recomendaciones|length > 50 %}...{% endif %}
                    </span>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> No se encontraron visitas que coincidan con los criterios de búsqueda.
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  // Activar tooltips
  $(function () {
    $('[data-toggle="tooltip"]').tooltip()
  })
</script>
{% endblock %}